<xml xmlns="https://developers.google.com/blockly/xml"><variables><variable id="A][^=5NzG?K{R!b}.#0(">SHAKER_BACKLASH</variable><variable id="FXbPGx.fQg_hd8Rc=6Tx">it_clips</variable><variable id="%?u?;wPJAg*{e{04Yk[%">twist_clips</variable><variable id=")c-Sj*?uoVCz#3Z(_):,">shake_clips</variable><variable id="4Y27HhHUYIX.[D8v:o;L">bop_clips</variable><variable id="+CkBN)|_6E9Xy#7sy^R`">action_to_cliptable_map</variable><variable id="2736;PQEHdmL*,IUG}@;">sound_schedule</variable><variable id="l+z%H.PQO@~VvSkD./jJ">closed_hi_hat_clip</variable><variable id="=QFwQaRZC{-^#$@gl.:)">dry_kick_clip</variable><variable id="nE$0R@]QJ{.rnHschg}J">note_length_multipliers</variable><variable id="2T]((sy_r/]ur!Jh2+Nx">speed_schedule</variable><variable id="(!wI)U4vCY:wG~H.osY:">motor_hysteresis</variable><variable id="u#TDD2esZ!E)+gBP(:`}">shaker_hysteresis</variable></variables><block type="function_definition" id="A1@hcz7O4b~Vp8,)1Jx=" x="-1070" y="-70"><mutation name="edges_to_bopit_action_e" functionid="PAS0D43pP4y~t;+x409^"><arg name="button_edge" id="rg4ylqf30mn9p054ev4tr9" type="boolean"/><arg name="motor_edge" id="57o2iknus9zeq8xcnpal" type="boolean"/><arg name="shaker_edge" id="392hacetb5ja4auipohq" type="boolean"/></mutation><field name="function_name">edges_to_bopit_action_e</field><value name="rg4ylqf30mn9p054ev4tr9"><shadow type="argument_reporter_boolean" id="LH9qJ]Hz=i-cJc)4azR0"><field name="VALUE">button_edge</field></shadow></value><value name="57o2iknus9zeq8xcnpal"><shadow type="argument_reporter_boolean" id="V]i4B%77;2)bgUy3/*sY"><field name="VALUE">motor_edge</field></shadow></value><value name="392hacetb5ja4auipohq"><shadow type="argument_reporter_boolean" id="Gy]+##R~#:orIs_OC?Gg"><field name="VALUE">shaker_edge</field></shadow></value><statement name="STACK"><block type="controls_if" id="I*2G*2cT!Mzu77`*{9s?"><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_operation" id="eg`A2Q.@|-i0XsJ~vS-Q"><field name="OP">AND</field><value name="A"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_operation" id="?IQ3s*c+D#v]CpP`fTp5"><field name="OP">AND</field><value name="A"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="argument_reporter_boolean" id="d!:I~:O1*5q/0RgC^IuG"><field name="VALUE">button_edge</field></block></value><value name="B"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_negate" id="m,13/Otj#.mVs=4aTeyT"><value name="BOOL"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="argument_reporter_boolean" id="j2^##ZA[_6bv4[TO)dF)"><field name="VALUE">motor_edge</field></block></value></block></value></block></value><value name="B"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_negate" id="tv5*u1!_,TyhnmDEu!G;"><value name="BOOL"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="argument_reporter_boolean" id="4##mko$G)=1p],(~ZF9q"><field name="VALUE">shaker_edge</field></block></value></block></value></block></value><statement name="DO0"><block type="function_return" id="CmIli_/R[dd/3MqU*|p="><mutation xmlns="http://www.w3.org/1999/xhtml" no_return_value="false"></mutation><value name="RETURN_VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="typescript_expression" id="6ee{Yut}6af4Bs{0a$3=" editable="false"><field name="EXPRESSION">bopit_action_e.BOPIT_ACTION_BOP</field></block></value></block></statement><next><block type="controls_if" id="H:7DHH|ZA]k]Iw6r;8J8"><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_operation" id="plqd4UgtPPEoywoa92^3"><field name="OP">AND</field><value name="A"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_operation" id="sd]HeVx@hy-p)f)r$_=A"><field name="OP">AND</field><value name="A"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_negate" id="bcUBSiw#!fSK$w[XVS|H"><value name="BOOL"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="argument_reporter_boolean" id="*FAY4e8/Jjs+x#KnP6Wy"><field name="VALUE">button_edge</field></block></value></block></value><value name="B"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="argument_reporter_boolean" id="8/|Eu:JEX{|Wf,(OzEf}"><field name="VALUE">motor_edge</field></block></value></block></value><value name="B"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_negate" id="VM84{):5:lYu/2U=U8KD"><value name="BOOL"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="argument_reporter_boolean" id="V0Lkn?tKaOYEz4#+b{VX"><field name="VALUE">shaker_edge</field></block></value></block></value></block></value><statement name="DO0"><block type="function_return" id="geOVuNnnPr2APi]UJ(:s"><mutation xmlns="http://www.w3.org/1999/xhtml" no_return_value="false"></mutation><value name="RETURN_VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="typescript_expression" id="l!y|$vyrwoXO=Y(Qp)]5" editable="false"><field name="EXPRESSION">bopit_action_e.BOPIT_ACTION_TWIST</field></block></value></block></statement><next><block type="controls_if" id="UmhmyUXh3#zUw26E(K#;"><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_operation" id="4/3Y!uoRt#/YLB^LiOVL"><field name="OP">AND</field><value name="A"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_operation" id="onJ]Cv7n]ie(9M[BRS(r"><field name="OP">AND</field><value name="A"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_negate" id="g.YRZnEuB$pQ=Y#xGTO:"><value name="BOOL"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="argument_reporter_boolean" id="WO-B*R}rWSOSiBI2b677"><field name="VALUE">button_edge</field></block></value></block></value><value name="B"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_negate" id="!KRrt8BGh:KEaE];UKz7"><value name="BOOL"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="argument_reporter_boolean" id="Y]m@3V`64g(5_a7kz{;#"><field name="VALUE">motor_edge</field></block></value></block></value></block></value><value name="B"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="argument_reporter_boolean" id="qHl5(|b(e58bI,q,t=8?"><field name="VALUE">shaker_edge</field></block></value></block></value><statement name="DO0"><block type="function_return" id="Q8]8u+vxFeWCDr[6;86~"><mutation xmlns="http://www.w3.org/1999/xhtml" no_return_value="false"></mutation><value name="RETURN_VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="typescript_expression" id=":m~/RDPI;W-]jw?/oKCH" editable="false"><field name="EXPRESSION">bopit_action_e.BOPIT_ACTION_SHAKE</field></block></value></block></statement><next><block type="function_return" id="Wavl=jV@a}IWxh~8V^Yr"><mutation xmlns="http://www.w3.org/1999/xhtml" no_return_value="false"></mutation><value name="RETURN_VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="typescript_expression" id="?!w~m8L.D^HCkv~E+YW6" editable="false"><field name="EXPRESSION">bopit_action_e.BOPIT_ACTION_NUM_ACTIONS</field></block></value></block></next></block></next></block></next></block></statement></block><block type="function_definition" id="!cf3v2r?JN=0%Y/`6~[i" x="220" y="-20"><mutation name="bopit_update" functionid="nCNU;YI@q2q(lX2-?~4v"/><field name="function_name">bopit_update</field></block><block type="forever" id="m,pXpZ8v|K,cn-$xfGh+" x="0" y="0"><statement name="HANDLER"><block type="control_run_in_parallel" id="LCcI#Mvl)w|CPUXah|Ci"><statement name="HANDLER"><block type="function_call" id="f`rv]ONCkWf]Ziq4hL!}"><mutation name="bopit_update" functionid="nCNU;YI@q2q(lX2-?~4v"/></block></statement><next><block type="console_log" id=",,)_=`)xc/p=7H:/*Mx,"><value name="value"><shadow type="text" id="P;q0V4C0u_RS`y3dg{|7"><field name="TEXT">this wait should be longer than the update takes?</field></shadow></value><next><block type="control_wait_us" id="{Se#XSc~r,S=KG!N1gdp"><value name="micros"><shadow type="math_number" id="hD9RQWFs:POxa7T3K*^J"><field name="NUM">4</field></shadow></value></block></next></block></next></block></statement></block><block type="pxt-on-start" id="7gX#ac=#SL8I(JYls28)" x="-1060" y="620"><statement name="HANDLER"><block type="console_log" id="8D*Fg-QXbp~fQe5=_Gw:"><value name="value"><shadow type="text" id="uOw~{bT[D%IgpwBq}N.w"><field name="TEXT">Disclaimer: figuring out what static typescript is oops</field></shadow></value><next><block type="console_log" id=".nS$A#3m42Sa?_|D%MH{"><value name="value"><shadow type="text" id="^2{?A+7JgK-[Ri=:45SK"><field name="TEXT">debounce.h</field></shadow></value><next><block type="typescript_statement" id=")ZO11m@-dX-j6{71Kd}z" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="interface debounce_state {" line1="    prev_sample: boolean," line2="    last_edge_time: number," line3="    debounce_interval: number," line4="    button_out: boolean" line5="}" numlines="6"></mutation><next><block type="console_log" id="w2;8B:Hd9cJM@!K0oy8L"><value name="value"><shadow type="text" id="%dpK[kI.;4X_m9MiuFb|"><field name="TEXT">debounce.c</field></shadow></value><next><block type="typescript_statement" id=":kd!DMMt;tl5VB$SG}JF" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="function debounce_button(db: debounce_state, button: boolean, time_now: number) {" line1="    if ((button == true) &amp;&amp; (db.prev_sample == false)) {" line2="        db.last_edge_time = time_now;" line3="    }" line4="" line5="    if ((button == false) &amp;&amp; (db.prev_sample == true)) {" line6="        db.last_edge_time = time_now;" line7="    }" line8="" line9="    db.prev_sample = button;" line10="" line11="    if ((time_now - db.last_edge_time) &gt; db.debounce_interval) {" line12="        db.button_out = button;" line13="    }" line14="" line15="    return db.button_out;" line16="}" numlines="17"></mutation><next><block type="console_log" id="q#g%,C]aNH:o!vZJo(6@"><value name="value"><shadow type="text" id="Aw||GdbDfV,ra{q,=}z@"><field name="TEXT">game.h</field></shadow></value><next><block type="typescript_statement" id="[f1~R1R.K=VoTG+i:/{I" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="enum bopit_action_e {" line1="    BOPIT_ACTION_TWIST = 0," line2="    BOPIT_ACTION_SHAKE = 1," line3="    BOPIT_ACTION_BOP = 2," line4="    BOPIT_ACTION_NUM_ACTIONS = 3" line5="}" numlines="6"></mutation><next><block type="typescript_statement" id="v?eW8G[z8,nQL^QhJsr." editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="enum beat_enum_e {" line1="    BEAT_ENUM_BEAT_1 = 0,       // &quot;command&quot;" line2="    BEAT_ENUM_BEAT_1_5 = 1,     // &quot;it&quot;" line3="    BEAT_ENUM_BEAT_2 = 2,       // hi-hat quarter note" line4="    BEAT_ENUM_BEAT_3 = 3,       // bass drum eighth note" line5="    BEAT_ENUM_BEAT_3_5 = 4,     // bass drum eighth note" line6="    BEAT_ENUM_BEAT_4 = 5,       // hi-hat quarter note" line7="    BEAT_ENUM_NUM_BEATS" line8="}" numlines="9"></mutation><next><block type="typescript_statement" id="%wmzqDA6/#8#:lK|$XP," editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="interface audio_clip { //TODO - how on earth will audio work" line1="    audio: number," line2="    audio_len: number" line3="}" numlines="4"></mutation><next><block type="typescript_statement" id="!JkplP-kUd`,hK%F@%CY" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="interface bopit_user_input { //TODO - dont understand yet" line1="    motor_voc_q8_8: number," line2="    shaker_voc_q8_8: number," line3="    button: number //should this be boolean?" line4="}" numlines="5"></mutation><next><block type="typescript_statement" id="z~PRmZNn{_+9+k3$`%#O" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="interface bopit_gamestate {" line1="    t_now: number," line2="    t_next_beat: number," line3="    // false if the game is still active, true if the player has lost." line4="    lost: boolean," line5="    // Holds the next expected action. Generated on beat 2 of each measure after a successful user action." line6="    ms_per_eighth_note: number," line7="    measure_number: number," line8="    expected_action: bopit_action_e," line9="    t_this_action: number," line10="    t_measure_start: number," line11="    action_window: number, // tolerance in time-domain for beat detection" line12="    beat_state: beat_enum_e," line13="    // linear-feedback shift register for random number generation" line14="    lfsr: number," line15="    // Variables for keeping track of previous UI state" line16="    bop_debouncer: debounce_state," line17="    button_prev: boolean," line18="    motor_prev: boolean," line19="    shaker_prev: boolean," line20="    tlastedge_button: number," line21="    tlastedge_motor: number," line22="    tlastedge_shaker: number," line23="    // If this is null, there's no sound ready to play." line24="    pending_audio: audio_clip //TODO" line25="}" numlines="26"></mutation><next><block type="console_log" id="kFj,%tL9xE[X,MaP2hpp"><value name="value"><shadow type="text" id="ug}Z6Vt0C@:C94=ey66B"><field name="TEXT">game.c</field></shadow></value><next><block type="variables_set" id="V#5m:t:%};v3P#-D+^g0"><field name="VAR" id="A][^=5NzG?K{R!b}.#0(">SHAKER_BACKLASH</field><value name="VALUE"><shadow type="math_number" id=";%fv|cVZ:jUIAC!O+vb9"><field name="NUM">600</field></shadow></value><next><block type="variables_set" id="F@8J)ZryBZP)Rx*OJ8%W"><field name="VAR" id="FXbPGx.fQg_hd8Rc=6Tx">it_clips</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="m![ZL9NGd?V0RqUZ*Lw}"><mutation items="4"/><value name="ADD0"><shadow type="math_number" id="yDKR!?okc.s*^Lt|PsL$"><field name="NUM">0</field></shadow></value><value name="ADD1"><shadow type="math_number" id="eyTT$w2{zCG8T9,YX[aE"><field name="NUM">0</field></shadow></value><value name="ADD2"><shadow type="math_number" id="9i}@jdK^4e1*K=zA5pcy"><field name="NUM">0</field></shadow></value><value name="ADD3"><shadow type="math_number" id="{%~@8OT[A/*q~7P8I$*A"><field name="NUM">0</field></shadow></value></block></value><next><block type="variables_set" id="*y3rx*$_!}y2VD:@IvLB"><field name="VAR" id="%?u?;wPJAg*{e{04Yk[%">twist_clips</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="ePPJ!D-Wx@L}h7|;`Nw("><mutation items="4"/><value name="ADD0"><shadow type="math_number" id="EBj~{)wH:v+)1!$*-Ktr"><field name="NUM">0</field></shadow></value><value name="ADD1"><shadow type="math_number" id="ty30UJ:f~pB:A!$xz/QB"><field name="NUM">0</field></shadow></value><value name="ADD2"><shadow type="math_number" id="4`$-uU*TUH!v%`J/G*Fy"><field name="NUM">0</field></shadow></value><value name="ADD3"><shadow type="math_number" id="d$#(G;:bt~nV0~0~84zJ"><field name="NUM">0</field></shadow></value></block></value><next><block type="variables_set" id="zR.h*_uZbK%x3uW^Xnsp"><field name="VAR" id=")c-Sj*?uoVCz#3Z(_):,">shake_clips</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="WjMR.(eOq-*bHjiXi^-}"><mutation items="4"/><value name="ADD0"><shadow type="math_number" id="2HrZNZ$8ZzPh~Sqo~I?u"><field name="NUM">0</field></shadow></value><value name="ADD1"><shadow type="math_number" id="Vib2ka*,UfY|hu6l[2fQ"><field name="NUM">0</field></shadow></value><value name="ADD2"><shadow type="math_number" id=".[OfW1}rJ_9*xfX(Oz)7"><field name="NUM">0</field></shadow></value><value name="ADD3"><shadow type="math_number" id="-Vs9KD+2p}Dq=.0k4@+8"><field name="NUM">0</field></shadow></value></block></value><next><block type="variables_set" id="QGAsw}bzWT=3uywQA@mQ"><field name="VAR" id="4Y27HhHUYIX.[D8v:o;L">bop_clips</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="~u=2o`8`MXu(*_f!=vl-"><mutation items="4"/><value name="ADD0"><shadow type="math_number" id="Z.-@AXqBe^vTv-5V)n~d"><field name="NUM">0</field></shadow></value><value name="ADD1"><shadow type="math_number" id="|Rg:)q=%5a;smPp#OWmF"><field name="NUM">0</field></shadow></value><value name="ADD2"><shadow type="math_number" id="e(:gpF.w{J8u+{q;eCBs"><field name="NUM">0</field></shadow></value><value name="ADD3"><shadow type="math_number" id="=6cK@znx]dXnucty^Y[s"><field name="NUM">0</field></shadow></value></block></value><next><block type="typescript_statement" id="{P}wL[hu;uLws2M`45DV" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let dry_kick_clip: audio_clip;" numlines="1" declaredvars="dry_kick_clip"></mutation><next><block type="typescript_statement" id="^|+?YQ`?a0voPd;EbLnE" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let closed_hi_hat_clip: audio_clip;" numlines="1" declaredvars="closed_hi_hat_clip"></mutation><next><block type="variables_set" id="Y)hwIEMs_Roy1s~7`whB"><field name="VAR" id="+CkBN)|_6E9Xy#7sy^R`">action_to_cliptable_map</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="%6Rtp.L;29H@$0P/V(qJ"><mutation items="3"/><value name="ADD0"><block type="variables_get" id="[Q#{b@mH@V[z(DrH=tMD"><field name="VAR" id="%?u?;wPJAg*{e{04Yk[%">twist_clips</field></block></value><value name="ADD1"><block type="variables_get" id="$:J;Nhvo:(:Uj=IJan4}"><field name="VAR" id=")c-Sj*?uoVCz#3Z(_):,">shake_clips</field></block></value><value name="ADD2"><block type="variables_get" id="pKbFJ?z+78u,BiAm(cr;"><field name="VAR" id="4Y27HhHUYIX.[D8v:o;L">bop_clips</field></block></value></block></value><next><block type="variables_set" id="Bm6JSjm.^.}lEC3ixtVg"><field name="VAR" id="2736;PQEHdmL*,IUG}@;">sound_schedule</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="Ij{]1OG1vr^=NZ7M+6uY" inline="false"><mutation items="6"/><value name="ADD0"><block type="typescript_expression" id="/YsVZ0f6{t.q!Xmoy`!t" editable="false"><field name="EXPRESSION">null</field></block></value><value name="ADD1"><block type="typescript_expression" id="u$a~$t5fLo18E`,r|q{2" editable="false"><field name="EXPRESSION">null</field></block></value><value name="ADD2"><block type="variables_get" id="n1Ct!k|%6Yv(TCzw.;kR"><field name="VAR" id="l+z%H.PQO@~VvSkD./jJ">closed_hi_hat_clip</field></block></value><value name="ADD3"><block type="variables_get" id="?p`TUD5$XoA_v4OIMCvn"><field name="VAR" id="=QFwQaRZC{-^#$@gl.:)">dry_kick_clip</field></block></value><value name="ADD4"><block type="variables_get" id="%S]nTb2J{xb^*E+{NTAv"><field name="VAR" id="=QFwQaRZC{-^#$@gl.:)">dry_kick_clip</field></block></value><value name="ADD5"><block type="variables_get" id="UpYOwgPF(l`Aw!X%UPfe"><field name="VAR" id="l+z%H.PQO@~VvSkD./jJ">closed_hi_hat_clip</field></block></value></block></value><next><block type="typescript_statement" id="Kc8vBZOe8~6t,hFIC#+W" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="function advance_lfsr(gs: bopit_gamestate) { // should work? js converts 64bit fp Numbers to 32bit signed ints before bitwise ops - scary" line1="    let bit = gs.lfsr &amp; 1;" line2="    gs.lfsr &gt;&gt;= 1;" line3="    if(bit) {" line4="        gs.lfsr ^= 0xA3000000;" line5="    }" line6="}" numlines="7"></mutation><next><block type="variables_set" id="VzE0UWLFLH|W27EkX1hC"><field name="VAR" id="nE$0R@]QJ{.rnHschg}J">note_length_multipliers</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="aOgUqHZbAf:ugObzfQS}" inline="false"><mutation items="7"/><value name="ADD0"><shadow type="math_number" id="]jA^Y|6n;ILnsU:l.zkF"><field name="NUM">1</field></shadow></value><value name="ADD1"><shadow type="math_number" id="7L],/7=7XCjS1qLVjBSi"><field name="NUM">1</field></shadow></value><value name="ADD2"><shadow type="math_number" id="Arnb9n6Srhr/ZB;Tg8j4"><field name="NUM">2</field></shadow></value><value name="ADD3"><shadow type="math_number" id="KL~s9yXjB,[UZOHVB7F|"><field name="NUM">1</field></shadow></value><value name="ADD4"><shadow type="math_number" id="c+4sj6J!N;0]M/TL~hgx"><field name="NUM">1</field></shadow></value><value name="ADD5"><shadow type="math_number" id="87(CAZIk%{T^dN||kCF)"><field name="NUM">2</field></shadow></value><value name="ADD6"><shadow type="math_number" id="nvw!y|xSeZ{MCXY#VP$x"><field name="NUM">65535</field></shadow></value></block></value><next><block type="variables_set" id="$iF$Ep3AjB?pxcgDId0A"><field name="VAR" id="2T]((sy_r/]ur!Jh2+Nx">speed_schedule</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="}!Ua[#@F5IGU%[Z+J4Cz" inline="false"><mutation items="9"/><value name="ADD0"><block type="lists_create_with" id="9HUBJ2UxmlMK_l;2uYCq"><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="~pyQ.D3bK/l);k@8EUSl"><field name="NUM">0</field></shadow></value><value name="ADD1"><shadow type="math_number" id="OO7EKluVP}*-nPMlF9a_"><field name="NUM">250</field></shadow></value></block></value><value name="ADD1"><block type="lists_create_with" id="7o++O:pUmodQ79S#%3X("><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="vJkBrKD?@*^=.`z$kO~X"><field name="NUM">12</field></shadow></value><value name="ADD1"><shadow type="math_number" id=";1r:(ayh30e#$ULwe/lt"><field name="NUM">227</field></shadow></value></block></value><value name="ADD2"><block type="lists_create_with" id="U(8!Ua0d,%(Cc!.fl!=M"><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="vevph(.ypQ$k+u2wG.I-"><field name="NUM">24</field></shadow></value><value name="ADD1"><shadow type="math_number" id="D/FgAix)]3h2[Tq5N.UK"><field name="NUM">208</field></shadow></value></block></value><value name="ADD3"><block type="lists_create_with" id="2[H3se)[-|m|9Cb)V)af"><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="4O?3@R2Nm3@Cw+[vu(kZ"><field name="NUM">36</field></shadow></value><value name="ADD1"><shadow type="math_number" id="aG~I;ml2?.?gS[By%:du"><field name="NUM">187</field></shadow></value></block></value><value name="ADD4"><block type="lists_create_with" id="CC#ImqF6Ys!Ab.yjTz9b"><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="if^:eU2Z[_(VD1G_:LnF"><field name="NUM">48</field></shadow></value><value name="ADD1"><shadow type="math_number" id="WCIm~hH:rDk_pA)VLdUd"><field name="NUM">174</field></shadow></value></block></value><value name="ADD5"><block type="lists_create_with" id="[Vg[yXPaJF$s~k:]{[TX"><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="T|)$Kh{}|)~T~.XD1z[["><field name="NUM">60</field></shadow></value><value name="ADD1"><shadow type="math_number" id="v1ocG_d=Enf?2:}2PVP+"><field name="NUM">163</field></shadow></value></block></value><value name="ADD6"><block type="lists_create_with" id="yqmgx!Fxu6v2h[n$c]Lt"><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="1:hI-I5N767ZJ])b,xfr"><field name="NUM">72</field></shadow></value><value name="ADD1"><shadow type="math_number" id="mUo;HhfsN8s1r|Ehn=O$"><field name="NUM">156</field></shadow></value></block></value><value name="ADD7"><block type="lists_create_with" id="XM)3OHrx@XEIY{XpB,pA"><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="RS~lHY3Bu?a5~oKq_b+/"><field name="NUM">84</field></shadow></value><value name="ADD1"><shadow type="math_number" id="Hk!6n9(]4-.jN#t}/on~"><field name="NUM">150</field></shadow></value></block></value><value name="ADD8"><block type="lists_create_with" id="vMZDA8]:@[}=62yCfJQ?"><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="+Z?4X#O}O43WK9-csQX*"><field name="NUM">65535</field></shadow></value><value name="ADD1"><shadow type="math_number" id="BDPKb.XNKqhrPlqT)r7A"><field name="NUM">100</field></shadow></value></block></value></block></value><next><block type="variables_set" id="t9V$wU*tQX|;Ov$^!{U^"><field name="VAR" id="(!wI)U4vCY:wG~H.osY:">motor_hysteresis</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="+EK.Jae%E5n76_^/tqDw"><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="`8e9T{Te@?hA}ly0r`#|"><field name="NUM">768</field></shadow></value><value name="ADD1"><shadow type="math_number" id="Q4b$T7{]08F0uKJU|N7:"><field name="NUM">512</field></shadow></value></block></value><next><block type="variables_set" id="HGdOPw,FWQEahb?M1bmk"><field name="VAR" id="u#TDD2esZ!E)+gBP(:`}">shaker_hysteresis</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="-9$ERh:beU)l*_kP)LFy"><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="Y{sS^G.)}a+$H6Bm;x*t"><field name="NUM">2048</field></shadow></value><value name="ADD1"><shadow type="math_number" id=".q|Nq~CF$zZQ)o^C?{3o"><field name="NUM">512</field></shadow></value></block></value><next><block type="console_log" id="SmOA@B-XBOZzp7?N0~U_"><value name="value"><shadow type="text" id="DciF1::-BslU|gmVFz{V"><field name="TEXT">this is not how this will be instantiated; will happen in a constructor called from main then passed to bopit_update_state from there</field></shadow></value><next><block type="typescript_statement" id="jp$7)z)E6YCl*AW6_lA{" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let bopit_gamestate_t = {" line1="    t_now: 0," line2="    t_next_beat: 0," line3="    lost: 0," line4="    ms_per_eighth_note: speed_schedule[0][1]," line5="    measure_number: 0," line6="    expected_action: bopit_action_e.BOPIT_ACTION_TWIST," line7="    t_this_action: 0, //gs-&gt;t_measure_start + 10 * gs-&gt;ms_per_eighth_note; //dont quite understand these yet" line8="    t_measure_start: 0, //-((int32_t)gs-&gt;ms_per_eighth_note) * 4;" line9="    action_window: 200," line10="    beat_state: beat_enum_e.BEAT_ENUM_BEAT_2," line11="    lfsr: 0xA5CE5b3A," line12="    bop_debouncer: {" line13="        prev_sample: false," line14="        last_edge_time: 0," line15="        debounce_interval: 10," line16="        button_out: false" line17="    }," line18="    button_prev: undefined as boolean," line19="    motor_prev: 0," line20="    shaker_prev: 0," line21="    tlastedge_button: undefined as number," line22="    tlastedge_motor: undefined as number," line23="    tlastedge_shaker: undefined as number," line24="    pending_audio: undefined as audio_clip" line25="};" numlines="26" declaredvars="bopit_gamestate_t"></mutation><next><block type="typescript_statement" id="tnmSFgp^DwvEEvGi4@0)" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="function bopit_update_state(gs: bopit_gamestate, input: bopit_user_input, dt_ms: number) {" line1="    gs.t_now += dt_ms;" line2="" line3="    // update state variables as appropriate on beats" line4="    if (gs.t_now &gt;= gs.t_next_beat) {" line5="        // advance beat state variables" line6="        gs.beat_state++;" line7="        if (gs.beat_state == beat_enum_e.BEAT_ENUM_NUM_BEATS) {" line8="            gs.beat_state = beat_enum_e.BEAT_ENUM_BEAT_1;" line9="            gs.t_measure_start = gs.t_next_beat;" line10="        }" line11="" line12="        // speed up if appropriate" line13="        if (gs.beat_state == beat_enum_e.BEAT_ENUM_BEAT_1) {" line14="            gs.measure_number++;" line15="            let sched_slot;" line16="            for (sched_slot = 1; speed_schedule[sched_slot][0] &lt; gs.measure_number; sched_slot++);" line17="            gs.ms_per_eighth_note = speed_schedule[sched_slot - 1][1];" line18="        }" line19="" line20="        // select proper sound to make pending" line21="        if (gs.beat_state == beat_enum_e.BEAT_ENUM_BEAT_1) {" line22="            for (let i = 0; i &lt; 4; i++, advance_lfsr(gs));" line23="            let clip_selection = (gs.lfsr &amp; 0x03);" line24="            //gs.pending_audio = action_to_cliptable_map[gs.expected_action][clip_selection];" line25="        } else if (gs.beat_state == beat_enum_e.BEAT_ENUM_BEAT_1_5) {" line26="            for (let j = 0; j &lt; 4; j++, advance_lfsr(gs));" line27="            let clip_selection2 = (gs.lfsr &amp; 0x03);" line28="            //gs.pending_audio = it_clips[clip_selection2];" line29="        } else {" line30="            //gs.pending_audio = sound_schedule[gs.beat_state];" line31="        }" line32="" line33="        // calculate next beat time" line34="        gs.t_next_beat += note_length_multipliers[gs.beat_state] * gs.ms_per_eighth_note;" line35="" line36="        // If we just played beat 4, schedule the next expected UI action" line37="    } else {" line38="        // clear pending sound" line39="        gs.pending_audio = undefined as audio_clip;" line40="    }" line41="    //gs-&gt;pending_audio = NULL;" line42="" line43="    // update ui beattimes" line44="    let button_now = debounce_button(gs.bop_debouncer, (input.button != 0), gs.t_now);" line45="    let motor_now = (input.motor_voc_q8_8 &gt; motor_hysteresis[(gs.motor_prev ? 1 : 0)]);" line46="    let shaker_now = (input.shaker_voc_q8_8 &gt; shaker_hysteresis[(gs.shaker_prev ? 1 : 0)]);" line47="" line48="    let button_trig = false;" line49="    let motor_trig = false;" line50="    let shaker_trig = false;" line51="    if (button_now &amp;&amp; !gs.button_prev) {" line52="        gs.tlastedge_button = gs.t_now;" line53="        button_trig = true;" line54="    }" line55="    if (motor_now &amp;&amp; !gs.motor_prev) {" line56="        gs.tlastedge_motor = gs.t_now;" line57="        motor_trig = true;" line58="    }" line59="    if ((shaker_now &amp;&amp; !gs.shaker_prev) &amp;&amp; ((gs.t_now - gs.tlastedge_shaker) &gt; SHAKER_BACKLASH)) {" line60="        gs.tlastedge_shaker = gs.t_now;" line61="        shaker_trig = true;" line62="    }" line63="" line64="    // check to see if the person missed a command" line65="    //if (button_trig || motor_trig || shaker_trig ||" line66="    if (motor_trig || shaker_trig ||" line67="        (gs.t_now &gt; (gs.t_this_action + (gs.action_window / 2)))) {" line68="        // check that the person did the right one" line69="        if ((edges_to_bopit_action_e(button_trig, motor_trig, shaker_trig) != gs.expected_action) ||" line70="            (gs.t_now &gt; (gs.t_this_action + (gs.action_window / 2))) ||" line71="            (gs.t_now &lt; (gs.t_this_action - (gs.action_window / 2)))) {" line72="            gs.lost = true;" line73="        }" line74="" line75="" line76="        for (let k = 0; k &lt; 4; k++, advance_lfsr(gs));" line77="" line78="        //gs-&gt;expected_action = ((uint8_t)gs-&gt;lfsr) % BOPIT_ACTION_NUM_ACTIONS;" line79="        //gs-&gt;expected_action = BOPIT_ACTION_TWIST;" line80="        gs.expected_action = (gs.lfsr &amp; 0x01) ? bopit_action_e.BOPIT_ACTION_TWIST : bopit_action_e.BOPIT_ACTION_SHAKE;" line81="" line82="        // TODO: this logic is slightly wrong when tempo increases." line83="        gs.t_this_action = gs.t_measure_start + (gs.ms_per_eighth_note * 10);" line84="    }" line85="" line86="    gs.button_prev = button_now;" line87="    gs.motor_prev = motor_now;" line88="    gs.shaker_prev = shaker_now;" line89="" line90="" line91="" line92="}" numlines="93"></mutation><next><block type="typescript_statement" id="#EB3Vf7!bw_Eg-,R.#~Z" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="function get_pending_audio_clip(gs: bopit_gamestate) {" line1="    return gs.pending_audio;" line2="}" numlines="3"></mutation></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block></xml>