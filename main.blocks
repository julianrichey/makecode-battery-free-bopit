<xml xmlns="https://developers.google.com/blockly/xml"><variables><variable id="l[Ooe-,CH0(3XrKpC|H`">SHAKER_BACKLASH</variable><variable id="p1Qah-H5`NnT#oga|ZiB">it_clips</variable><variable id="MVf{@}aS,8+=)v*GLDc,">twist_clips</variable><variable id="-O`sM~fd!gkg}1]7.Q?m">shake_clips</variable><variable id=":?TY0|xZTq5gD2_G~M=d">bop_clips</variable><variable id="F86RB8MZm6Hiot2(+6Mk">action_to_cliptable_map</variable><variable id="A)SA,keEC.U5ey8k}Qe@">sound_schedule</variable><variable id="g_fw]-E#XaH45r-_YjoX">closed_hi_hat_clip</variable><variable id="!Dokh=C;9vFXVQt=rTtp">dry_kick_clip</variable><variable id="KH1E755xyxiSX?F^C11S">note_length_multipliers</variable><variable id="{@H|XT,$X*`#]b(M@3RI">speed_schedule</variable><variable id="oKx5_xt[:)HrygRR/oOq">motor_hysteresis</variable><variable id="@(inudp2,@JY2@2)rmW%">shaker_hysteresis</variable></variables><block type="function_definition" id="N`,Refw^AJE?a);LdR_@" x="-1060" y="-60"><mutation name="edges_to_bopit_action_e" functionid="Q=c?lFgTOnV3cdTbKqTG"><arg name="button_edge" id="0b3tehidtdbla0tql416" type="boolean"/><arg name="motor_edge" id="vgudwk4x5k0fv7h8dkpg" type="boolean"/><arg name="shaker_edge" id="2n4z2p9xuiyhbc5vw9l59" type="boolean"/></mutation><field name="function_name">edges_to_bopit_action_e</field><statement name="STACK"><block type="controls_if" id="6.D,~E:)TQO3$^,(eF?F"><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_operation" id=",%_ZM_D0lH#?j0ooVF)7"><field name="OP">AND</field><value name="A"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_operation" id="wB-ca{[$k80RrZtX;[mo"><field name="OP">AND</field><value name="A"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="argument_reporter_boolean" id="[+LF,4)3~B1/qpI!NW.!"><field name="VALUE">button_edge</field></block></value><value name="B"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_negate" id="$fLI0.{j;!_bP0!q|hU:"><value name="BOOL"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="argument_reporter_boolean" id="`pHZx=mRs`WP*nmt0@;w"><field name="VALUE">motor_edge</field></block></value></block></value></block></value><value name="B"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_negate" id="B$Tb:9IZS*3qJlUJ4P+X"><value name="BOOL"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="argument_reporter_boolean" id="x=Gx^mddAUEwa(sEDho|"><field name="VALUE">shaker_edge</field></block></value></block></value></block></value><statement name="DO0"><block type="function_return" id="#0WV[kG^[J[;D,,-np7d"><mutation xmlns="http://www.w3.org/1999/xhtml" no_return_value="false"></mutation><value name="RETURN_VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="typescript_expression" id="I8=1kh9yxREy@^$g3:`E" editable="false"><field name="EXPRESSION">bopit_action_e.BOPIT_ACTION_BOP</field></block></value></block></statement><next><block type="controls_if" id="+^GLB?Ue!kE_0LM`wkiB"><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_operation" id="*F_gNP7,3oCC`mn{It}q"><field name="OP">AND</field><value name="A"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_operation" id="|VMk$XxhvRT;+@CG-[Q^"><field name="OP">AND</field><value name="A"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_negate" id="8zX:_dM]:+mCM?ZLxZ^V"><value name="BOOL"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="argument_reporter_boolean" id="ysnC*X?4lAG3N%CEpyiw"><field name="VALUE">button_edge</field></block></value></block></value><value name="B"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="argument_reporter_boolean" id="js+ttH0`yIYB#Fs[:muZ"><field name="VALUE">motor_edge</field></block></value></block></value><value name="B"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_negate" id="vCV6~eAuTSX1L3tbD)3`"><value name="BOOL"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="argument_reporter_boolean" id="D.7-er1T,pkt*,xfqXwZ"><field name="VALUE">shaker_edge</field></block></value></block></value></block></value><statement name="DO0"><block type="function_return" id="S(;,,1}3=!dfXhs;C}j+"><mutation xmlns="http://www.w3.org/1999/xhtml" no_return_value="false"></mutation><value name="RETURN_VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="typescript_expression" id="mx6tYyw+As}@~H-3Z.((" editable="false"><field name="EXPRESSION">bopit_action_e.BOPIT_ACTION_TWIST</field></block></value></block></statement><next><block type="controls_if" id="*d-_?DoZJx4Ar20q3I;G"><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_operation" id="fS65X5k~S$CJAcl8`fUv"><field name="OP">AND</field><value name="A"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_operation" id="1Zen=QwJqU8uNx/[9~Pp"><field name="OP">AND</field><value name="A"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_negate" id="#@0-sHLVDTv^a19j+J!:"><value name="BOOL"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="argument_reporter_boolean" id=",I+v)f5-+SKzlZGZyKd;"><field name="VALUE">button_edge</field></block></value></block></value><value name="B"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_negate" id="b)#~g=Q4M|{;2*=cIbrw"><value name="BOOL"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="argument_reporter_boolean" id="Oj:?(+zhF:c4R6G.^GvL"><field name="VALUE">motor_edge</field></block></value></block></value></block></value><value name="B"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="argument_reporter_boolean" id="^w1RXUIg1+f.~A%HP1V5"><field name="VALUE">shaker_edge</field></block></value></block></value><statement name="DO0"><block type="function_return" id="!f?fcl@-U?w*E+Btl2NG"><mutation xmlns="http://www.w3.org/1999/xhtml" no_return_value="false"></mutation><value name="RETURN_VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="typescript_expression" id="S91;FY4m@m`h97amxrJ=" editable="false"><field name="EXPRESSION">bopit_action_e.BOPIT_ACTION_SHAKE</field></block></value></block></statement><next><block type="function_return" id="/Hk]@2U}527ruY#:5a)t"><mutation xmlns="http://www.w3.org/1999/xhtml" no_return_value="false"></mutation><value name="RETURN_VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="typescript_expression" id="b00]mN#S/`[CVHAzVI4P" editable="false"><field name="EXPRESSION">bopit_action_e.BOPIT_ACTION_NUM_ACTIONS</field></block></value></block></next></block></next></block></next></block></statement></block><block type="forever" id="/L7yk:T*C.Qvp@$sY1-N" x="0" y="0"/><block type="pxt-on-start" id="TQkYdBVUaEWt{p[G_g,5" x="-1050" y="630"><statement name="HANDLER"><block type="console_log" id="M;TnRciv+MhL)qgsRxP["><value name="value"><shadow type="text" id="i9[ga1~2H+Fpn%Mm;z3t"><field name="TEXT">debounce.h</field></shadow></value><next><block type="typescript_statement" id="6CmB!lf~ZL*y!_28O,9I" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="interface debounce_state {" line1="    prev_sample: boolean," line2="    last_edge_time: number," line3="    debounce_interval: number," line4="    button_out: boolean" line5="}" numlines="6"></mutation><next><block type="console_log" id="|n+4yKs({so5_7VS~2]%"><value name="value"><shadow type="text" id="U/;6W%uCr4n]c|PK!4oc"><field name="TEXT">debounce.c</field></shadow></value><next><block type="typescript_statement" id="533bPQWT^[}M*0,BD4Y~" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="function debounce_button(db: debounce_state, button: boolean, time_now: number) {" line1="    if ((button == true) &amp;&amp; (db.prev_sample == false)) {" line2="        db.last_edge_time = time_now;" line3="    }" line4="" line5="    if ((button == false) &amp;&amp; (db.prev_sample == true)) {" line6="        db.last_edge_time = time_now;" line7="    }" line8="" line9="    db.prev_sample = button;" line10="" line11="    if ((time_now - db.last_edge_time) &gt; db.debounce_interval) {" line12="        db.button_out = button;" line13="    }" line14="" line15="    return db.button_out;" line16="}" numlines="17"></mutation><next><block type="console_log" id="vV~s0+=w9|t4#,EIl-)A"><value name="value"><shadow type="text" id="qlT$!m86w7Wdb5w51jwy"><field name="TEXT">game.h</field></shadow></value><next><block type="typescript_statement" id="tC$c@[LfevbFFt.D0x(x" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="enum bopit_action_e {" line1="    BOPIT_ACTION_TWIST = 0," line2="    BOPIT_ACTION_SHAKE = 1," line3="    BOPIT_ACTION_BOP = 2," line4="    BOPIT_ACTION_NUM_ACTIONS = 3" line5="}" numlines="6"></mutation><next><block type="typescript_statement" id="bk1t}=PpzjGy:|cmvg.i" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="enum beat_enum_e {" line1="    BEAT_ENUM_BEAT_1 = 0,       // &quot;command&quot;" line2="    BEAT_ENUM_BEAT_1_5 = 1,     // &quot;it&quot;" line3="    BEAT_ENUM_BEAT_2 = 2,       // hi-hat quarter note" line4="    BEAT_ENUM_BEAT_3 = 3,       // bass drum eighth note" line5="    BEAT_ENUM_BEAT_3_5 = 4,     // bass drum eighth note" line6="    BEAT_ENUM_BEAT_4 = 5,       // hi-hat quarter note" line7="    BEAT_ENUM_NUM_BEATS" line8="}" numlines="9"></mutation><next><block type="typescript_statement" id="w^{.PkH#z!w/+3)A=h93" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="interface audio_clip { //TODO - how on earth will audio work" line1="    audio: number," line2="    audio_len: number" line3="}" numlines="4"></mutation><next><block type="typescript_statement" id="A`42tZ+DA.2bk~`{Spt." editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="interface bopit_user_input { //TODO - dont understand yet" line1="    motor_voc_q8_8: number," line2="    shaker_voc_q8_8: number," line3="    button: number //should this be boolean?" line4="}" numlines="5"></mutation><next><block type="typescript_statement" id="kTrb4d$U%G3W!!8Rsbw^" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="interface bopit_gamestate {" line1="    t_now: number," line2="    t_next_beat: number," line3="    // false if the game is still active, true if the player has lost." line4="    lost: boolean," line5="    // Holds the next expected action. Generated on beat 2 of each measure after a successful user action." line6="    ms_per_eighth_note: number," line7="    measure_number: number," line8="    expected_action: bopit_action_e," line9="    t_this_action: number," line10="    t_measure_start: number," line11="    action_window: number, // tolerance in time-domain for beat detection" line12="    beat_state: beat_enum_e," line13="    // linear-feedback shift register for random number generation" line14="    lfsr: number," line15="    // Variables for keeping track of previous UI state" line16="    bop_debouncer: debounce_state," line17="    button_prev: boolean," line18="    motor_prev: boolean," line19="    shaker_prev: boolean," line20="    tlastedge_button: number," line21="    tlastedge_motor: number," line22="    tlastedge_shaker: number," line23="    // If this is null, there's no sound ready to play." line24="    pending_audio: audio_clip //TODO" line25="}" numlines="26"></mutation><next><block type="console_log" id=")H$IAxEZ9udMPcCg)WWT"><value name="value"><shadow type="text" id="[h^PDWJTUE?rllc,MDn-"><field name="TEXT">game.c</field></shadow></value><next><block type="variables_set" id="0Y*Q9lr=aZq??;.DESR?"><field name="VAR" id="l[Ooe-,CH0(3XrKpC|H`">SHAKER_BACKLASH</field><value name="VALUE"><shadow type="math_number" id="]d+$9!R[EVfNI[S2C?%9"><field name="NUM">600</field></shadow></value><next><block type="variables_set" id=".uN9,(X{j8#Yf9),Z7Ba"><field name="VAR" id="p1Qah-H5`NnT#oga|ZiB">it_clips</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="46DvVeEHj3sW)V}}=$(n"><mutation items="4"/><value name="ADD0"><shadow type="math_number" id="{I_+Dl/@mVK5@a:3eMcg"><field name="NUM">0</field></shadow></value><value name="ADD1"><shadow type="math_number" id="h_0b,p!e}~tjL8!}Y{eX"><field name="NUM">0</field></shadow></value><value name="ADD2"><shadow type="math_number" id="V}9g?WG,uGi}HC+|q*Tm"><field name="NUM">0</field></shadow></value><value name="ADD3"><shadow type="math_number" id="=h)$8!T.D+F6B.gUl@9z"><field name="NUM">0</field></shadow></value></block></value><next><block type="variables_set" id="^!5V.!cAJBQ].01E4t)T"><field name="VAR" id="MVf{@}aS,8+=)v*GLDc,">twist_clips</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="[TrJ7a~.P0bgLbB5404p"><mutation items="4"/><value name="ADD0"><shadow type="math_number" id="Ngn*W-#}ZRgf#H#Z@#Y0"><field name="NUM">0</field></shadow></value><value name="ADD1"><shadow type="math_number" id="Ays2-UYg1?6h]Xg=1-D%"><field name="NUM">0</field></shadow></value><value name="ADD2"><shadow type="math_number" id=":,)/N20/?iCC0jc}PM#2"><field name="NUM">0</field></shadow></value><value name="ADD3"><shadow type="math_number" id="h1l|2L:psdFM%?8UI^$m"><field name="NUM">0</field></shadow></value></block></value><next><block type="variables_set" id="cj}vwb0sxxr[K{UkJ%vn"><field name="VAR" id="-O`sM~fd!gkg}1]7.Q?m">shake_clips</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="(lPtUO:UfdpE@D2hBoRG"><mutation items="4"/><value name="ADD0"><shadow type="math_number" id="xg412;p(,)NSnJR_{`ZS"><field name="NUM">0</field></shadow></value><value name="ADD1"><shadow type="math_number" id="O+EP!w!ktUT_S[x8a(z["><field name="NUM">0</field></shadow></value><value name="ADD2"><shadow type="math_number" id="E$nEb7!f*0oc4/H]o!{p"><field name="NUM">0</field></shadow></value><value name="ADD3"><shadow type="math_number" id="cFaF-=nu%gcddiLJ(9JZ"><field name="NUM">0</field></shadow></value></block></value><next><block type="variables_set" id="*O5*(Yv/UQLO+{~2:qH("><field name="VAR" id=":?TY0|xZTq5gD2_G~M=d">bop_clips</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="RG;%n]*cQNIIiC#T-.N8"><mutation items="4"/><value name="ADD0"><shadow type="math_number" id="x4BLFfcOm|9=tGnNg%H9"><field name="NUM">0</field></shadow></value><value name="ADD1"><shadow type="math_number" id="t~Vey/]+}|2OYQRj-/K1"><field name="NUM">0</field></shadow></value><value name="ADD2"><shadow type="math_number" id="Otrt6URCkOgdRHdfGm_("><field name="NUM">0</field></shadow></value><value name="ADD3"><shadow type="math_number" id="YsNsMupqR$-]GY$4NqXv"><field name="NUM">0</field></shadow></value></block></value><next><block type="typescript_statement" id=";V4.03mbp2)KCh|KY*-2" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let dry_kick_clip: audio_clip;" numlines="1" declaredvars="dry_kick_clip"></mutation><next><block type="typescript_statement" id="i*pX$bzN[??@(m!IoE{k" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let closed_hi_hat_clip: audio_clip;" numlines="1" declaredvars="closed_hi_hat_clip"></mutation><next><block type="variables_set" id="kxmP}jIwb{}b{Mwrya/*"><field name="VAR" id="F86RB8MZm6Hiot2(+6Mk">action_to_cliptable_map</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="`R|i|rt(3U[j*,aeUATl"><mutation items="3"/><value name="ADD0"><block type="variables_get" id="OHF(vdie?TZ-oj`CGwnZ"><field name="VAR" id="MVf{@}aS,8+=)v*GLDc,">twist_clips</field></block></value><value name="ADD1"><block type="variables_get" id="-7F.4josxn)oY.?zQzVJ"><field name="VAR" id="-O`sM~fd!gkg}1]7.Q?m">shake_clips</field></block></value><value name="ADD2"><block type="variables_get" id="}bSNr)#|[fPG`*tPZE-s"><field name="VAR" id=":?TY0|xZTq5gD2_G~M=d">bop_clips</field></block></value></block></value><next><block type="variables_set" id="DYkTX3ZpC)^Q0zX0BR|W"><field name="VAR" id="A)SA,keEC.U5ey8k}Qe@">sound_schedule</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="EE55fdUxc|.(p[~[O]PI" inline="false"><mutation items="6"/><value name="ADD0"><block type="typescript_expression" id="t4ud-J-P1t7/:?(wj,}z" editable="false"><field name="EXPRESSION">null</field></block></value><value name="ADD1"><block type="typescript_expression" id="Zd((Pz-lexVhWW[r7`7z" editable="false"><field name="EXPRESSION">null</field></block></value><value name="ADD2"><block type="variables_get" id="NLSrA!Yj)jR3^9`Leb=f"><field name="VAR" id="g_fw]-E#XaH45r-_YjoX">closed_hi_hat_clip</field></block></value><value name="ADD3"><block type="variables_get" id="7$uxL:c;gb].NPk_aXf1"><field name="VAR" id="!Dokh=C;9vFXVQt=rTtp">dry_kick_clip</field></block></value><value name="ADD4"><block type="variables_get" id="*9rwQ]_R[^-dc#I=K#5V"><field name="VAR" id="!Dokh=C;9vFXVQt=rTtp">dry_kick_clip</field></block></value><value name="ADD5"><block type="variables_get" id="61H(AuI9,T5($]YVR64~"><field name="VAR" id="g_fw]-E#XaH45r-_YjoX">closed_hi_hat_clip</field></block></value></block></value><next><block type="typescript_statement" id="y|8k`QzYoXrfs$Z=l;[}" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="function advance_lfsr(gs: bopit_gamestate) { // should work? js converts 64bit fp Numbers to 32bit signed ints before bitwise ops - scary" line1="    let bit = gs.lfsr &amp; 1;" line2="    gs.lfsr &gt;&gt;= 1;" line3="    if(bit) {" line4="        gs.lfsr ^= 0xA3000000;" line5="    }" line6="}" numlines="7"></mutation><next><block type="variables_set" id="txon,39rCx9-FaKmi!=J"><field name="VAR" id="KH1E755xyxiSX?F^C11S">note_length_multipliers</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="EK8WJpw9+pUag^5lQYS)" inline="false"><mutation items="7"/><value name="ADD0"><shadow type="math_number" id="!U3dj8t8=tp|%Q`+yJ=6"><field name="NUM">1</field></shadow></value><value name="ADD1"><shadow type="math_number" id="S*RN%c%^.I/XwuB)?_!N"><field name="NUM">1</field></shadow></value><value name="ADD2"><shadow type="math_number" id="hKNXf^T}q@5*[,O!M2lT"><field name="NUM">2</field></shadow></value><value name="ADD3"><shadow type="math_number" id=":fk!12!aMb9XDqpCoQ5H"><field name="NUM">1</field></shadow></value><value name="ADD4"><shadow type="math_number" id="/|o*NIK*Z)K0^zyxs:n["><field name="NUM">1</field></shadow></value><value name="ADD5"><shadow type="math_number" id="St9+[h5n{?m$)MR2$Y}$"><field name="NUM">2</field></shadow></value><value name="ADD6"><shadow type="math_number" id="ngH?]O+BquAZY51KJx46"><field name="NUM">65535</field></shadow></value></block></value><next><block type="variables_set" id="{|Rtw5dDbmf~R!`-OU%)"><field name="VAR" id="{@H|XT,$X*`#]b(M@3RI">speed_schedule</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="t^6r#TF=qlb)bLDDN6^z" inline="false"><mutation items="9"/><value name="ADD0"><block type="lists_create_with" id="3@`36[AQI*(cz5*Y!=.M"><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="BaWOO$6dhAVRlhj$|pnT"><field name="NUM">0</field></shadow></value><value name="ADD1"><shadow type="math_number" id="FC_;9bP?#($Ps3~1pQeY"><field name="NUM">250</field></shadow></value></block></value><value name="ADD1"><block type="lists_create_with" id="yRQ4Z.mM=p{,EgI`czz@"><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="[?FTsxA`bUZbqKOXqG1A"><field name="NUM">12</field></shadow></value><value name="ADD1"><shadow type="math_number" id=".V-OpasvVXS4G#[eEC#R"><field name="NUM">227</field></shadow></value></block></value><value name="ADD2"><block type="lists_create_with" id="N^20?B$~U`A]z@wNBoUG"><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="$Qn:K$m+Y|VszIIT|)nr"><field name="NUM">24</field></shadow></value><value name="ADD1"><shadow type="math_number" id="[|R4y;=-hOrHR|?1Y^ZT"><field name="NUM">208</field></shadow></value></block></value><value name="ADD3"><block type="lists_create_with" id="XyeQXXTnxItwHRz)f_vQ"><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="`EO3s^W@c=z0KM8VYy~."><field name="NUM">36</field></shadow></value><value name="ADD1"><shadow type="math_number" id="PrF}M}3WrX;h@NKy${K2"><field name="NUM">187</field></shadow></value></block></value><value name="ADD4"><block type="lists_create_with" id="Ekp5RHVxl87KX58__5/m"><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="a]f|V(#}*EG:j[iKfvH%"><field name="NUM">48</field></shadow></value><value name="ADD1"><shadow type="math_number" id="b+lj#LD0(Glr~roZw0CK"><field name="NUM">174</field></shadow></value></block></value><value name="ADD5"><block type="lists_create_with" id="uEigZvNj`3mz=c7QZ6.q"><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="-Qt9#%y#uy/aVDy2~Au*"><field name="NUM">60</field></shadow></value><value name="ADD1"><shadow type="math_number" id="TX/_$B1pEbz~m8}:CD1%"><field name="NUM">163</field></shadow></value></block></value><value name="ADD6"><block type="lists_create_with" id="[/,/u1T=)x?3`K[n6u}w"><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="-T%]?x}73u|/3y!indlo"><field name="NUM">72</field></shadow></value><value name="ADD1"><shadow type="math_number" id="~YYb0y!zDG3L`by+YjNW"><field name="NUM">156</field></shadow></value></block></value><value name="ADD7"><block type="lists_create_with" id="C{:2!?88vGpGVnhDPUu%"><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="z4QBZu!PGR(,^`z(Y@)0"><field name="NUM">84</field></shadow></value><value name="ADD1"><shadow type="math_number" id="_E(DjQ}+^/NMVRf4K/}T"><field name="NUM">150</field></shadow></value></block></value><value name="ADD8"><block type="lists_create_with" id="V1|{:)7{=|0[;u7DRwOM"><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="nM~FJ-4=2fSR{Y+}$M$U"><field name="NUM">65535</field></shadow></value><value name="ADD1"><shadow type="math_number" id="O^XbM*ucSbRZZU|tXR;g"><field name="NUM">100</field></shadow></value></block></value></block></value><next><block type="variables_set" id="|LKoe0u~tyvzu~IiIl7}"><field name="VAR" id="oKx5_xt[:)HrygRR/oOq">motor_hysteresis</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="7wQg}i%,=-T!8qB7[EU)"><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="VJc^]xKFRT(kV}^k*Q1a"><field name="NUM">768</field></shadow></value><value name="ADD1"><shadow type="math_number" id="HXxqgn_e{$uJu)eU4~st"><field name="NUM">512</field></shadow></value></block></value><next><block type="variables_set" id="{0L`o*-;J:pdgxjKvrh8"><field name="VAR" id="@(inudp2,@JY2@2)rmW%">shaker_hysteresis</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_create_with" id="l-Y_ZXN$L2:YO9%(_Q3t"><mutation items="2"/><value name="ADD0"><shadow type="math_number" id="}/t%JXrRnwkjP4#GCxNv"><field name="NUM">2048</field></shadow></value><value name="ADD1"><shadow type="math_number" id="9~;Rn9pJ+Q/z5N!o;]O+"><field name="NUM">512</field></shadow></value></block></value><next><block type="console_log" id="5d2[/YV20Zlnig[)-@o6"><value name="value"><shadow type="text" id="_p-*vV3;hl^6Jb,ZeYUv"><field name="TEXT">this is not how this will be instantiated; will happen in a constructor called from main then passed to bopit_update_state from there</field></shadow></value><next><block type="typescript_statement" id="/XEWV`F-Z8HD8P)#JI(7" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let bopit_gamestate_t = {" line1="    t_now: 0," line2="    t_next_beat: 0," line3="    lost: 0," line4="    ms_per_eighth_note: speed_schedule[0][1]," line5="    measure_number: 0," line6="    expected_action: bopit_action_e.BOPIT_ACTION_TWIST," line7="    t_this_action: 0, //gs-&gt;t_measure_start + 10 * gs-&gt;ms_per_eighth_note; //dont quite understand these yet" line8="    t_measure_start: 0, //-((int32_t)gs-&gt;ms_per_eighth_note) * 4;" line9="    action_window: 200," line10="    beat_state: beat_enum_e.BEAT_ENUM_BEAT_2," line11="    lfsr: 0xA5CE5b3A," line12="    bop_debouncer: {" line13="        prev_sample: false," line14="        last_edge_time: 0," line15="        debounce_interval: 10," line16="        button_out: false" line17="    }," line18="    button_prev: undefined as boolean," line19="    motor_prev: 0," line20="    shaker_prev: 0," line21="    tlastedge_button: undefined as number," line22="    tlastedge_motor: undefined as number," line23="    tlastedge_shaker: undefined as number," line24="    pending_audio: undefined as audio_clip" line25="};" numlines="26" declaredvars="bopit_gamestate_t"></mutation><next><block type="typescript_statement" id="k8b#LG6,MUoF3qmvFEc7" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="function bopit_update_state(gs: bopit_gamestate, input: bopit_user_input, dt_ms: number) {" line1="    gs.t_now += dt_ms;" line2="" line3="    // update state variables as appropriate on beats" line4="    if (gs.t_now &gt;= gs.t_next_beat) {" line5="        // advance beat state variables" line6="        gs.beat_state++;" line7="        if (gs.beat_state == beat_enum_e.BEAT_ENUM_NUM_BEATS) {" line8="            gs.beat_state = beat_enum_e.BEAT_ENUM_BEAT_1;" line9="            gs.t_measure_start = gs.t_next_beat;" line10="        }" line11="" line12="        // speed up if appropriate" line13="        if (gs.beat_state == beat_enum_e.BEAT_ENUM_BEAT_1) {" line14="            gs.measure_number++;" line15="            let sched_slot;" line16="            for (sched_slot = 1; speed_schedule[sched_slot][0] &lt; gs.measure_number; sched_slot++);" line17="            gs.ms_per_eighth_note = speed_schedule[sched_slot - 1][1];" line18="        }" line19="" line20="        // select proper sound to make pending" line21="        if (gs.beat_state == beat_enum_e.BEAT_ENUM_BEAT_1) {" line22="            for (let i = 0; i &lt; 4; i++, advance_lfsr(gs));" line23="            let clip_selection = (gs.lfsr &amp; 0x03);" line24="            //gs.pending_audio = action_to_cliptable_map[gs.expected_action][clip_selection];" line25="        } else if (gs.beat_state == beat_enum_e.BEAT_ENUM_BEAT_1_5) {" line26="            for (let j = 0; j &lt; 4; j++, advance_lfsr(gs));" line27="            let clip_selection2 = (gs.lfsr &amp; 0x03);" line28="            //gs.pending_audio = it_clips[clip_selection2];" line29="        } else {" line30="            //gs.pending_audio = sound_schedule[gs.beat_state];" line31="        }" line32="" line33="        // calculate next beat time" line34="        gs.t_next_beat += note_length_multipliers[gs.beat_state] * gs.ms_per_eighth_note;" line35="" line36="        // If we just played beat 4, schedule the next expected UI action" line37="    } else {" line38="        // clear pending sound" line39="        gs.pending_audio = undefined as audio_clip;" line40="    }" line41="    //gs-&gt;pending_audio = NULL;" line42="" line43="    // update ui beattimes" line44="    let button_now = debounce_button(gs.bop_debouncer, (input.button != 0), gs.t_now);" line45="    let motor_now = (input.motor_voc_q8_8 &gt; motor_hysteresis[(gs.motor_prev ? 1 : 0)]);" line46="    let shaker_now = (input.shaker_voc_q8_8 &gt; shaker_hysteresis[(gs.shaker_prev ? 1 : 0)]);" line47="" line48="    let button_trig = false;" line49="    let motor_trig = false;" line50="    let shaker_trig = false;" line51="    if (button_now &amp;&amp; !gs.button_prev) {" line52="        gs.tlastedge_button = gs.t_now;" line53="        button_trig = true;" line54="    }" line55="    if (motor_now &amp;&amp; !gs.motor_prev) {" line56="        gs.tlastedge_motor = gs.t_now;" line57="        motor_trig = true;" line58="    }" line59="    if ((shaker_now &amp;&amp; !gs.shaker_prev) &amp;&amp; ((gs.t_now - gs.tlastedge_shaker) &gt; SHAKER_BACKLASH)) {" line60="        gs.tlastedge_shaker = gs.t_now;" line61="        shaker_trig = true;" line62="    }" line63="" line64="    // check to see if the person missed a command" line65="    //if (button_trig || motor_trig || shaker_trig ||" line66="    if (motor_trig || shaker_trig ||" line67="        (gs.t_now &gt; (gs.t_this_action + (gs.action_window / 2)))) {" line68="        // check that the person did the right one" line69="        if ((edges_to_bopit_action_e(button_trig, motor_trig, shaker_trig) != gs.expected_action) ||" line70="            (gs.t_now &gt; (gs.t_this_action + (gs.action_window / 2))) ||" line71="            (gs.t_now &lt; (gs.t_this_action - (gs.action_window / 2)))) {" line72="            gs.lost = true;" line73="        }" line74="" line75="" line76="        for (let k = 0; k &lt; 4; k++, advance_lfsr(gs));" line77="" line78="        //gs-&gt;expected_action = ((uint8_t)gs-&gt;lfsr) % BOPIT_ACTION_NUM_ACTIONS;" line79="        //gs-&gt;expected_action = BOPIT_ACTION_TWIST;" line80="        gs.expected_action = (gs.lfsr &amp; 0x01) ? bopit_action_e.BOPIT_ACTION_TWIST : bopit_action_e.BOPIT_ACTION_SHAKE;" line81="" line82="        // TODO: this logic is slightly wrong when tempo increases." line83="        gs.t_this_action = gs.t_measure_start + (gs.ms_per_eighth_note * 10);" line84="    }" line85="" line86="    gs.button_prev = button_now;" line87="    gs.motor_prev = motor_now;" line88="    gs.shaker_prev = shaker_now;" line89="" line90="" line91="" line92="}" numlines="93"></mutation><next><block type="typescript_statement" id="4l#lB^$J,K$xB:(I@mpU" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="function get_pending_audio_clip(gs: bopit_gamestate) {" line1="    return gs.pending_audio;" line2="}" numlines="3"></mutation></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block></xml>